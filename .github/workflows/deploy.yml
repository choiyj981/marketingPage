name: ìë™ ë°°í¬

# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  # ============================================
  # 1ë‹¨ê³„: ë°°í¬ ì „ ê²€ì¦
  # ============================================
  validate:
    name: ì½”ë“œ ê²€ì¦ ë° ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: TypeScript íƒ€ì… ì²´í¬
      run: npm run check
    
    - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: npm run build
    
    - name: ê²€ì¦ ì™„ë£Œ
      run: echo "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼! ë¹Œë“œ ë° ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."

  # ============================================
  # 2ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hub í‘¸ì‹œ
  # ============================================
  build-and-push:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hub í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: validate  # ê²€ì¦ í†µê³¼ í›„ ì‹¤í–‰
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: Docker Hub ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Git ì»¤ë°‹ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
      id: git-commit-time
      run: |
        COMMIT_TIME=$(git log -1 --format=%ci)
        echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT
        echo "Git ì»¤ë°‹ ì‹œê°„: $COMMIT_TIME"
    
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: docckerchoi/marketingpage:latest
        cache-from: type=registry,ref=docckerchoi/marketingpage:latest
        cache-to: type=inline
        build-args: |
          GIT_COMMIT_TIME=${{ steps.git-commit-time.outputs.commit_time }}

  # ============================================
  # 3ë‹¨ê³„: ì„œë²„ ë°°í¬ (ë¹Œë“œ ì—†ìŒ!)
  # ============================================
  deploy:
    name: ì„œë²„ì— ìë™ ë°°í¬
    runs-on: ubuntu-latest
    needs: build-and-push  # ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # SSH ê°œì¸ í‚¤ ì €ì¥ (ì—¬ëŸ¬ ì¤„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬)
        # base64 ë””ì½”ë”© ì‹œë„ (í•„ìš”í•œ ê²½ìš°)
        if echo "${{ secrets.SSH_PRIVATE_KEY }}" | grep -q "BEGIN"; then
          # ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        else
          # base64ë¡œ ì¸ì½”ë”©ëœ ê²½ìš° ë””ì½”ë”©
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_ed25519
        fi
        
        chmod 600 ~/.ssh/id_ed25519
        
        # SSH í‚¤ í˜•ì‹ í™•ì¸
        echo "SSH í‚¤ íŒŒì¼ í™•ì¸:"
        head -n 1 ~/.ssh/id_ed25519
        echo "í‚¤ íŒŒì¼ í¬ê¸°:"
        ls -lh ~/.ssh/id_ed25519
        
        # ì„œë²„ í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        chmod 644 ~/.ssh/known_hosts
    
    - name: SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      run: |
        echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
        ssh -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} echo "SSH ì—°ê²° ì„±ê³µ!"
    
    - name: ì„œë²„ì— ë°°í¬
      run: |
        ssh -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          echo "ğŸš€ ë°°í¬ ì‹œì‘..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ~/marketingPage || cd ~/marketingpage || { echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"; exit 1; }
          
          # Gitì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
          git pull origin main
          
          # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ â†’ DB ë™ê¸°í™” (ë©”íƒ€ë°ì´í„°ë§Œ)
          echo "ğŸ“ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ â†’ DB ë™ê¸°í™”..."
          docker-compose -f docker-compose.prod.yml exec -T app npm run sync-md-to-db || {
            echo "âš ï¸  ë§ˆí¬ë‹¤ìš´ ë™ê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          }
          
          # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (ë¹Œë“œ ì—†ìŒ!)
          echo "ğŸ³ Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°..."
          docker-compose -f docker-compose.prod.yml pull || {
            echo "âŒ ì´ë¯¸ì§€ pull ì‹¤íŒ¨!"
            exit 1
          }
          
          # ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ (ì´ë¯¸ì§€ë§Œ êµì²´)
          echo "ğŸ”„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘..."
          docker-compose -f docker-compose.prod.yml up -d || {
            echo "âŒ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨!"
            exit 1
          }
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "âœ… ë°°í¬ ì™„ë£Œ! ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          docker-compose -f docker-compose.prod.yml ps
          
          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ìµœê·¼ 20ì¤„)
          echo ""
          echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ í™•ì¸..."
          docker-compose -f docker-compose.prod.yml logs --tail=20 app || true
          
          echo ""
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        EOF
    
    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "âœ… ì„œë²„ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ì„œë²„ ì£¼ì†Œ: http://35.237.229.92:8080"
