name: ìë™ ë°°í¬

# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ì„œë²„ì— ìë™ ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: SSH í‚¤ ì„¤ì •
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # SSH ê°œì¸ í‚¤ ì €ì¥ (ì—¬ëŸ¬ ì¤„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬)
        # base64 ë””ì½”ë”© ì‹œë„ (í•„ìš”í•œ ê²½ìš°)
        if echo "${{ secrets.SSH_PRIVATE_KEY }}" | grep -q "BEGIN"; then
          # ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        else
          # base64ë¡œ ì¸ì½”ë”©ëœ ê²½ìš° ë””ì½”ë”©
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_ed25519
        fi
        
        chmod 600 ~/.ssh/id_ed25519
        
        # SSH í‚¤ í˜•ì‹ í™•ì¸
        echo "SSH í‚¤ íŒŒì¼ í™•ì¸:"
        head -n 1 ~/.ssh/id_ed25519
        echo "í‚¤ íŒŒì¼ í¬ê¸°:"
        ls -lh ~/.ssh/id_ed25519
        
        # ì„œë²„ í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        chmod 644 ~/.ssh/known_hosts
    
    - name: SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      run: |
        echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
        ssh -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} echo "SSH ì—°ê²° ì„±ê³µ!"
    
    - name: ì„œë²„ì— ë°°í¬
      run: |
        ssh -o StrictHostKeyChecking=no -o BatchMode=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          echo "ğŸš€ ë°°í¬ ì‹œì‘..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ~/marketingPage || cd ~/marketingpage || { echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"; exit 1; }
          
          # Gitì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
          git pull origin main
          
          # Docker ì´ë¯¸ì§€ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          echo "ë¹Œë“œ ì‹œì‘ ì‹œê°„: $(date)"
          
          # ë¹Œë“œ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ 15ë¶„ ì„¤ì •)
          timeout 900 docker-compose -f docker-compose.prod.yml build --no-cache --progress=plain 2>&1 | tee /tmp/build.log || {
            BUILD_EXIT_CODE=$?
            echo ""
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨! (ì¢…ë£Œ ì½”ë“œ: $BUILD_EXIT_CODE)"
            echo "ë¹Œë“œ ì‹¤íŒ¨ ì‹œê°„: $(date)"
            echo ""
            echo "=== ë¹Œë“œ ë¡œê·¸ (ë§ˆì§€ë§‰ 50ì¤„) ==="
            tail -50 /tmp/build.log || cat /tmp/build.log
            echo ""
            exit 1
          }
          
          echo ""
          echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
          echo "ë¹Œë“œ ì™„ë£Œ ì‹œê°„: $(date)"
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘..."
          docker-compose -f docker-compose.prod.yml up -d || {
            echo "âŒ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨!"
            exit 1
          }
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "âœ… ë°°í¬ ì™„ë£Œ! ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          docker-compose -f docker-compose.prod.yml ps
          
          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ìµœê·¼ 20ì¤„)
          echo ""
          echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ í™•ì¸..."
          docker-compose -f docker-compose.prod.yml logs --tail=20 app || true
          
          echo ""
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        EOF
    
    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "âœ… ì„œë²„ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ì„œë²„ ì£¼ì†Œ: http://34.73.27.245:8080"

