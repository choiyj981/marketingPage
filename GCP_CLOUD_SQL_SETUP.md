# Google Cloud SQL 설정 가이드 (쉬운 설명)

이 문서는 비유를 사용해서 Google Cloud SQL을 쉽게 이해하고 설정하는 방법을 설명합니다.

---

## 📖 목차

- [인스턴스 개념 이해하기](#인스턴스-개념-이해하기)
- [Cloud SQL 인스턴스 생성하기](#cloud-sql-인스턴스-생성하기)
- [데이터베이스 생성하기](#데이터베이스-생성하기)
- [Cloud Run에 연결하기](#cloud-run에-연결하기)
- [환경 변수 설정하기](#환경-변수-설정하기)
- [데이터베이스 스키마 생성하기](#데이터베이스-스키마-생성하기)
- [문제 해결](#문제-해결)

---

## 인스턴스 개념 이해하기

### 비유로 이해하기

**인스턴스 = 컴퓨터 한 대**

```
[구글 클라우드]
│
├── [컴퓨터 1번] - Cloud Run 인스턴스 (웹사이트 서버)
│   └── Express.js 서버 실행 중
│   └── 사용자 요청 처리
│   └── "안녕하세요" 같은 HTML 제공
│
└── [컴퓨터 2번] - Cloud SQL 인스턴스 (데이터베이스 서버) ← 이제 만들 예정
    └── PostgreSQL 데이터베이스 실행 중
    └── 데이터 저장 (사용자 정보, 블로그 글 등)
    └── "데이터 어디 있어?" 질문에 답변
```

### 왜 2개의 컴퓨터가 필요한가?

**비유:**
- 컴퓨터 1번 (웹사이트 서버): 식당의 홀
  - 손님 접대, 주문 받기
  - 음식 주문 처리
- 컴퓨터 2번 (데이터베이스 서버): 식당의 냉장고
  - 음식 재료 저장
  - 재고 관리

**분리하는 이유:**
1. 각각 독립적으로 확장 가능
   - 손님이 많아지면 홀만 늘리면 됨
   - 냉장고는 하나면 충분
2. 안정성 향상
   - 홀 컴퓨터가 고장나도 냉장고는 안전
   - 냉장고 컴퓨터가 고장나도 홀은 작동 (데이터만 못 가져옴)
3. 관리 용이
   - 각각 따로 백업/수리 가능

### 현재 상황

```
✅ [컴퓨터 1번] - Cloud Run 인스턴스 (웹사이트 서버)
   - 서비스 이름: business-jun-site
   - 상태: 실행 중
   - URL: https://business-jun-site-466122825675.europe-west1.run.app

❌ [컴퓨터 2번] - Cloud SQL 인스턴스 (데이터베이스 서버)
   - 상태: 아직 없음
   - 지금 만들 예정!
```

---

## Cloud SQL 인스턴스 생성하기

### 목표
데이터를 저장할 냉장고(PostgreSQL 데이터베이스 서버) 만들기

### 진행 시간
2025년 11월 5일

### 단계별 작업

#### 1단계: GCP 콘솔에서 Cloud SQL 접속

1. GCP 콘솔 (https://console.cloud.google.com) 접속
2. 왼쪽 메뉴에서 "SQL" 검색 또는 클릭
3. "Cloud SQL" 클릭

**비유:**
- 구글 클라우드 = 대형 마트
- Cloud SQL = 전자제품 코너
- 냉장고(PostgreSQL) 살 곳 찾기

---

#### 2단계: 인스턴스 만들기

1. "인스턴스 만들기" 버튼 클릭
2. "PostgreSQL" 선택
3. "다음" 클릭

**비유:**
- 냉장고 종류 선택
- PostgreSQL = 냉장고 (데이터 저장용)

---

#### 3단계: 인스턴스 정보 설정

**인스턴스 ID:**
- 예: `marketingpage-db`
- 설명: 냉장고 이름 (나중에 찾기 쉬운 이름)

**비밀번호:**
- 냉장고 열쇠 (중요!)
- 예: `MySecurePassword123!`
- 기억해두세요! (나중에 필요함)

**데이터베이스 버전:**
- PostgreSQL 15 (최신 버전 선택)

**비유:**
- 인스턴스 ID = 냉장고 이름
- 비밀번호 = 냉장고 열쇠
- 버전 = 냉장고 모델 (최신 모델 선택)

---

#### 4단계: 리전 선택

**리전:**
- Cloud Run과 같은 리전 선택 권장
- 현재 Cloud Run: `europe-west1` (벨기에)
- 또는 `asia-northeast3` (서울) 선택 가능

**비유:**
- 리전 = 냉장고 위치
- 웹사이트 서버와 가까이 두면 빠름
- 한국 사용자면 서울이 좋음

**권장:**
- 한국 사용자: `asia-northeast3` (서울)
- 또는 Cloud Run과 같은 리전: `europe-west1`

---

#### 5단계: 머신 구성 (비용 관리)

**머신 구성:**
- 개발/테스트: `공유 코어` (무료 티어)
- 프로덕션: `표준` (CPU 1개, 메모리 3.75GB)

**비유:**
- 공유 코어 = 작은 냉장고 (무료지만 느림)
- 표준 = 보통 냉장고 (유료지만 빠름)

**권장:**
- 처음에는 "공유 코어" 선택 (무료)
- 나중에 필요하면 업그레이드

---

#### 6단계: 연결 설정

**공개 IP:**
- "공개 IP 주소" 선택 (기본값)

**비유:**
- 공개 IP = 냉장고에 전화번호 붙이기
- Cloud Run 서버가 전화해서 연결할 수 있게 함

---

#### 7단계: 인스턴스 만들기

1. 모든 설정 확인
2. "만들기" 버튼 클릭
3. 5-10분 대기 (냉장고 설치 중)

**비유:**
- 냉장고 주문 완료
- 설치 기다리는 중

---

## 데이터베이스 생성하기

### 목표
냉장고 안에 선반(데이터베이스) 만들기

### 진행 시간
2025년 11월 5일

### 단계별 작업

#### 1단계: 생성된 인스턴스 클릭

1. Cloud SQL 인스턴스 목록에서 방금 만든 인스턴스 클릭
2. 상세 페이지로 이동

**비유:**
- 냉장고 설치 완료
- 냉장고 문 열기

---

#### 2단계: 데이터베이스 탭으로 이동

1. 상단 메뉴에서 "데이터베이스" 탭 클릭
2. "데이터베이스 만들기" 버튼 클릭

**비유:**
- 냉장고 안에 선반 만들기
- 데이터를 정리해서 보관할 공간 만들기

---

#### 3단계: 데이터베이스 이름 입력

**데이터베이스 이름:**
- 예: `marketingpage`
- 설명: 선반 이름 (나중에 데이터 찾을 때 사용)

**비유:**
- 선반 이름 = 데이터베이스 이름
- "블로그 글 선반", "사용자 정보 선반"처럼 구분

---

#### 4단계: 데이터베이스 만들기

1. "만들기" 버튼 클릭
2. 완료!

**비유:**
- 선반 설치 완료
- 이제 데이터를 넣을 수 있음

---

## Cloud Run에 연결하기

### 목표
웹사이트 서버(컴퓨터 1번)와 데이터베이스 서버(컴퓨터 2번)를 전화선으로 연결하기

### 진행 시간
2025년 11월 5일

### 단계별 작업

#### 1단계: Cloud Run 서비스 편집

1. GCP 콘솔에서 "Cloud Run" 클릭
2. `business-jun-site` 서비스 클릭
3. "편집 및 새 버전 배포" 버튼 클릭

**비유:**
- 웹사이트 서버(컴퓨터 1번) 설정 변경
- 데이터베이스 서버(컴퓨터 2번)와 연결하기 위해 설정 추가

---

#### 2단계: Cloud SQL 연결 추가

1. "네트워킹, 보안, VPC" 탭 클릭
2. "Cloud SQL 연결" 섹션 찾기
3. "연결 추가" 또는 "+" 버튼 클릭
4. 방금 만든 Cloud SQL 인스턴스 선택
5. "완료" 클릭

**비유:**
- 전화선 연결하기
- 컴퓨터 1번(웹사이트 서버)과 컴퓨터 2번(데이터베이스 서버) 사이에 전화선 연결
- 이제 서로 통화할 수 있음

---

#### 3단계: 저장 및 배포

1. "배포" 또는 "저장" 버튼 클릭
2. 재배포 시작 (1-2분 소요)

**비유:**
- 연결 설정 완료
- 서버 재시작해서 연결 확인

---

## 환경 변수 설정하기

### 목표
주소록에 데이터베이스 주소 적기 (서버가 데이터베이스를 찾을 수 있게)

### 진행 시간
2025년 11월 5일

### 단계별 작업

#### 1단계: Cloud SQL 연결 정보 확인

1. Cloud SQL 인스턴스 상세 페이지로 이동
2. "연결" 탭 클릭
3. "Cloud SQL 연결" 섹션에서 연결 이름 확인

**연결 이름 형식:**
```
프로젝트ID:리전:인스턴스ID
예: my-project-12345:europe-west1:marketingpage-db
```

**비유:**
- 연결 이름 = 데이터베이스 전화번호
- 서버가 이 번호로 데이터베이스에 전화함

---

#### 2단계: Cloud Run 환경 변수 설정

1. Cloud Run 서비스 상세 페이지로 이동
2. "편집 및 새 버전 배포" 클릭
3. "컨테이너" 탭 클릭
4. "환경 변수" 섹션 찾기
5. "환경 변수 추가" 클릭

**비유:**
- 주소록에 주소 적기
- 서버가 데이터베이스를 찾을 수 있게 주소 적어둠

---

#### 3단계: 환경 변수 추가

**변수 1: DATABASE_URL**

**방법 1: Cloud SQL 연결 사용 (권장)**
```
변수 이름: DATABASE_URL
변수 값: postgresql://사용자명:비밀번호@localhost/데이터베이스명?host=/cloudsql/프로젝트ID:리전:인스턴스ID
```

**예시:**
```
postgresql://postgres:MySecurePassword123!@localhost/marketingpage?host=/cloudsql/my-project-12345:europe-west1:marketingpage-db
```

**설명:**
- `postgres`: 기본 사용자명
- `MySecurePassword123!`: 인스턴스 만들 때 설정한 비밀번호
- `marketingpage`: 데이터베이스 이름
- `/cloudsql/...`: Cloud SQL 연결 이름

**비유:**
- 주소록에 적는 내용:
  - 이름: postgres
  - 비밀번호: 열쇠 번호
  - 위치: /cloudsql/연결이름
  - 선반: marketingpage

---

**변수 2: SESSION_SECRET**

```
변수 이름: SESSION_SECRET
변수 값: 랜덤 문자열 (예: openssl rand -hex 32 실행 결과)
```

**비유:**
- 세션 암호화용 비밀번호
- 로그인 정보를 안전하게 보관하기 위한 열쇠

**랜덤 문자열 생성 방법:**
- 온라인 생성기: https://randomkeygen.com/
- 또는 터미널: `openssl rand -hex 32`

---

**변수 3: NODE_ENV**

```
변수 이름: NODE_ENV
변수 값: production
```

**비유:**
- 환경 모드 설정
- "프로덕션 환경"이라고 알려주기

---

#### 4단계: 저장 및 배포

1. 모든 환경 변수 추가 완료 확인
2. "배포" 버튼 클릭
3. 재배포 시작

**비유:**
- 주소록 작성 완료
- 서버 재시작해서 주소록 읽기

---

## 데이터베이스 스키마 생성하기

### 목표
냉장고 안에 선반(데이터베이스)에 정리함(테이블) 만들기

### 진행 시간
2025년 11월 5일

### 단계별 작업

#### 1단계: Cloud Run 터미널 접속

1. Cloud Run 서비스 상세 페이지로 이동
2. "버전" 탭 클릭
3. 최신 버전 클릭
4. "로그" 탭에서 터미널 접속 가능 여부 확인

**또는 로컬에서 연결:**

1. Cloud SQL 인스턴스의 "연결" 탭으로 이동
2. "Cloud Shell에서 연결" 클릭
3. 또는 로컬에서 `gcloud` 명령어 사용

**비유:**
- 냉장고 문 열기
- 선반에 정리함 만들 준비

---

#### 2단계: 데이터베이스 연결 확인

**로컬에서 연결하는 방법:**

1. Cloud SQL 인스턴스의 "연결" 탭에서 "공개 IP" 확인
2. 로컬 `.env` 파일에 연결 정보 추가:

```env
DATABASE_URL=postgresql://postgres:비밀번호@공개IP:5432/marketingpage
```

**비유:**
- 로컬 컴퓨터에서 냉장고에 연결
- 주소록에 공개 IP 주소 적기

---

#### 3단계: 스키마 생성

**로컬 터미널에서:**

```bash
cd "C:\Users\CYJ\Desktop\모든파일\파이썬자동화프로그램\웹사이트"
npm run db:push
```

**예상 결과:**
```
> rest-express@1.0.0 db:push
> drizzle-kit push

[✓] Pulling schema from database...
[✓] Changes applied
```

**비유:**
- 선반에 정리함 만들기
- users 정리함, blog_posts 정리함 등 만들기
- 데이터를 넣을 준비 완료

---

## 전체 구조 이해하기

### 최종 구조

```
[구글 클라우드]
│
├── [컴퓨터 1번] - Cloud Run 인스턴스 (웹사이트 서버)
│   ├── Express.js 서버 실행 중
│   ├── 환경 변수:
│   │   ├── DATABASE_URL (데이터베이스 주소)
│   │   ├── SESSION_SECRET (세션 암호화)
│   │   └── NODE_ENV (production)
│   └── 전화선 연결: Cloud SQL 연결
│
└── [컴퓨터 2번] - Cloud SQL 인스턴스 (데이터베이스 서버)
    ├── PostgreSQL 실행 중
    ├── 데이터베이스: marketingpage
    └── 테이블들:
        ├── users (사용자 정보)
        ├── blog_posts (블로그 글)
        ├── products (제품 정보)
        └── ...
```

### 데이터 흐름

```
[1] 사용자가 웹사이트 접속
    ↓
[2] Cloud Run 서버 (컴퓨터 1번)가 요청 받음
    ↓
[3] 데이터가 필요하면 Cloud SQL (컴퓨터 2번)에 전화
    ↓
[4] Cloud SQL이 데이터 찾아서 반환
    ↓
[5] Cloud Run 서버가 HTML 만들어서 사용자에게 제공
```

**비유:**
- 손님이 식당에 주문
- 홀 직원(웹사이트 서버)이 주문 받음
- 재료가 필요하면 냉장고(데이터베이스)에서 가져옴
- 음식 만들어서 손님에게 제공

---

## 문제 해결

### 문제 1: 연결 실패

**증상:**
```
Error connecting to database
```

**원인:**
- Cloud SQL 연결이 안 됨
- 환경 변수 설정 오류

**해결:**
1. Cloud Run 서비스에서 Cloud SQL 연결 확인
2. 환경 변수 DATABASE_URL 확인
3. 연결 이름 형식 확인

---

### 문제 2: 비밀번호 오류

**증상:**
```
authentication failed
```

**원인:**
- DATABASE_URL의 비밀번호가 틀림

**해결:**
1. Cloud SQL 인스턴스 비밀번호 확인
2. DATABASE_URL의 비밀번호 수정
3. 서비스 재배포

---

### 문제 3: 데이터베이스 없음

**증상:**
```
database does not exist
```

**원인:**
- 데이터베이스를 생성하지 않음

**해결:**
1. Cloud SQL 인스턴스에서 데이터베이스 생성
2. DATABASE_URL의 데이터베이스 이름 확인

---

## 체크리스트

### Cloud SQL 인스턴스 생성
- [ ] GCP 콘솔에서 Cloud SQL 접속
- [ ] PostgreSQL 인스턴스 생성
- [ ] 인스턴스 ID 설정
- [ ] 비밀번호 설정 (기억해두기!)
- [ ] 리전 선택 (서울 또는 Cloud Run과 같은 리전)
- [ ] 머신 구성 선택 (공유 코어 또는 표준)
- [ ] 인스턴스 생성 완료 (5-10분 대기)

### 데이터베이스 생성
- [ ] 생성된 인스턴스 클릭
- [ ] 데이터베이스 탭으로 이동
- [ ] 데이터베이스 생성 (이름: marketingpage)

### Cloud Run 연결
- [ ] Cloud Run 서비스 편집
- [ ] 네트워킹 탭으로 이동
- [ ] Cloud SQL 연결 추가
- [ ] 생성한 인스턴스 선택
- [ ] 저장 및 배포

### 환경 변수 설정
- [ ] Cloud Run 서비스 편집
- [ ] 컨테이너 탭으로 이동
- [ ] 환경 변수 추가:
  - [ ] DATABASE_URL (Cloud SQL 연결 정보)
  - [ ] SESSION_SECRET (랜덤 문자열)
  - [ ] NODE_ENV (production)
- [ ] 저장 및 배포

### 데이터베이스 스키마 생성
- [ ] 로컬에서 Cloud SQL 연결
- [ ] npm run db:push 실행
- [ ] 테이블 생성 확인

---

## 학습 포인트

### 인스턴스 개념
- **인스턴스 = 컴퓨터 한 대**
- Cloud Run 인스턴스 = 웹사이트 서버 컴퓨터
- Cloud SQL 인스턴스 = 데이터베이스 서버 컴퓨터
- 각각 독립적으로 작동

### 연결 개념
- **Cloud SQL 연결 = 전화선**
- Cloud Run 서버와 Cloud SQL 서버를 연결
- 같은 GCP 프로젝트 내에서 안전하게 연결

### 환경 변수 개념
- **환경 변수 = 주소록**
- 서버가 데이터베이스를 찾을 수 있게 주소 적어둠
- DATABASE_URL = 데이터베이스 주소
- SESSION_SECRET = 세션 암호화 열쇠

### 데이터베이스 구조
- **인스턴스 = 냉장고**
- **데이터베이스 = 선반**
- **테이블 = 정리함**
- 데이터가 들어가는 최종 위치

---

## 다음 단계

### 완료된 작업
- ✅ Cloud Run 서비스 생성 (웹사이트 서버)
- ✅ Dockerfile 생성 및 배포

### 진행 중인 작업
- ⏳ Cloud SQL 인스턴스 생성
- ⏳ 데이터베이스 생성
- ⏳ Cloud Run 연결
- ⏳ 환경 변수 설정
- ⏳ 데이터베이스 스키마 생성

### 예정된 작업
- [ ] 웹사이트 접속 테스트
- [ ] 데이터베이스 연결 확인
- [ ] 사용자 인증 기능 테스트

---

**마지막 업데이트:** 2025년 11월 5일

